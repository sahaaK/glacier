<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SYLEAD Unemployment & Immigration Survey - Analysis Dashboard</title>
    <link rel="icon" href="https://sylead-surveys.netlify.app/logo.png">
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- AOS (Animate On Scroll) -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Custom Styles -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

:root {
    --bg-white: #ffffff;
    --text-dark: #0f172a;
    --muted: #64748b;
    --border: rgba(15, 23, 42, 0.08);
    --shadow: 0 8px 30px rgba(2, 6, 23, 0.08);
    --glass: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(15, 23, 42, 0.08);
}

* { box-sizing: border-box; }

html, body {
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    background: var(--bg-white);
    color: var(--text-dark);
}

.container {
    max-width: 1280px;
}

/* Glassmorphism cards */
.glassmorphism {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    box-shadow: var(--shadow);
    border-radius: 16px;
}

/* Metric cards */
.metric-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px;
    border-radius: 16px;
    background: rgba(255,255,255,0.8);
    border: 1px solid rgba(15,23,42,0.06);
    box-shadow: 0 10px 30px rgba(2,6,23,0.06);
    transition: transform .2s ease, box-shadow .2s ease;
}
.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 40px rgba(2,6,23,0.10);
}
.metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.metric-content { line-height: 1.2; }
.metric-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; }
.metric-value { font-size: 24px; font-weight: 800; }

/* Chart cards */
.chart-card {
    background: rgba(255,255,255,0.85);
    border: 1px solid rgba(15,23,42,0.06);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    box-shadow: 0 12px 34px rgba(2,6,23,0.08);
    border-radius: 20px;
    overflow: hidden;
    transition: transform .25s ease, box-shadow .25s ease;
}
.chart-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 16px 44px rgba(2,6,23,0.12);
}
.chart-header {
    padding: 16px 18px 0 18px;
}
.chart-title {
    font-weight: 800;
    font-size: 16px;
    line-height: 1.2;
}
.chart-subtitle {
    color: var(--muted);
    font-size: 12px;
}
.chart-body {
    padding: 8px 14px 14px 14px;
}

/* Buttons */
.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    letter-spacing: .02em;
    cursor: pointer;
    transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    box-shadow: 0 10px 24px rgba(99,102,241,0.35);
}
.btn-primary:hover {
    transform: translateY(-1px);
    filter: brightness(1.05);
    box-shadow: 0 12px 30px rgba(99,102,241,0.45);
}
.btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: rgba(15,23,42,0.06);
    color: #111827;
    border: 1px solid rgba(15,23,42,0.08);
    border-radius: 12px;
    font-weight: 700;
    letter-spacing: .02em;
    cursor: pointer;
    transition: background .2s ease, transform .2s ease;
}
.btn-secondary:hover {
    background: rgba(15,23,42,0.10);
    transform: translateY(-1px);
}

/* Floating animated bubbles (subtle, behind content) */
.bubble {
    position: absolute;
    border-radius: 9999px;
    filter: blur(2px);
    opacity: 0.35;
    animation: float 18s linear infinite;
}
.bubble-1 {
    width: 120px; height: 120px; background: #a78bfa; top: 10%; left: 5%;
    animation-duration: 22s;
}
.bubble-2 {
    width: 160px; height: 160px; background: #60a5fa; top: 25%; right: 8%;
    animation-duration: 26s;
}
.bubble-3 {
    width: 90px; height: 90px; background: #34d399; bottom: 15%; left: 20%;
    animation-duration: 20s;
}
.bubble-4 {
    width: 140px; height: 140px; background: #f59e0b; bottom: 20%; right: 12%;
    animation-duration: 24s;
}
.bubble-5 {
    width: 110px; height: 110px; background: #f472b6; top: 50%; left: 50%;
    animation-duration: 28s;
}
.bubble-6 {
    width: 80px; height: 80px; background: #22d3ee; top: 60%; left: 35%;
    animation-duration: 19s;
}

@keyframes float {
    0% { transform: translateY(0) translateX(0) scale(1); }
    50% { transform: translateY(-30px) translateX(15px) scale(1.05); }
    100% { transform: translateY(0) translateX(0) scale(1); }
}

/* Responsive tweaks */
@media (max-width: 640px) {
    .metric-value { font-size: 20px; }
}
  </style>
</head>
<body class="min-h-screen bg-white text-gray-900">
    <!-- Floating Bubbles (Futuristic, Slick) -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div class="bubble bubble-1"></div>
        <div class="bubble bubble-2"></div>
        <div class="bubble bubble-3"></div>
        <div class="bubble bubble-4"></div>
        <div class="bubble bubble-5"></div>
        <div class="bubble bubble-6"></div>
    </div>

    <!-- Header -->
    <header class="py-8" data-aos="fade-down">
        <div class="container mx-auto px-4">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <div class="flex items-center gap-4">
                    <img src="https://sylead-surveys.netlify.app/logo.png" alt="SYLEAD" class="h-14 w-14 object-contain">
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-extrabold tracking-tight">
                            Unemployment & Immigration Survey Analysis
                        </h1>
                        <p class="text-gray-600">SYLEAD - Dashboard, Insights & Visual Analytics</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                    <div id="dataSourceBadge" class="inline-flex items-center gap-2 rounded-full px-4 py-2 bg-blue-50 text-blue-700 border border-blue-200">
                        <i data-feather="database" class="w-4 h-4"></i>
                        <span class="text-sm font-medium" id="dataSourceText">Loading...</span>
                    </div>
                    <div id="lastUpdated" class="text-sm text-gray-500">Last updated: —</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Controls -->
    <section class="container mx-auto px-4 mb-6" data-aos="fade-up">
        <div class="glassmorphism rounded-2xl p-4">
            <div class="flex flex-wrap items-center gap-4">
                <button id="refreshBtn" class="btn-primary">
                    <i data-feather="refresh-ccw" class="w-4 h-4"></i>
                    Refresh Data
                </button>
                <button id="exportPngBtn" class="btn-secondary">
                    <i data-feather="image" class="w-4 h-4"></i>
                    Export Charts as PNG
                </button>
                <button id="exportCsvBtn" class="btn-secondary">
                    <i data-feather="download-cloud" class="w-4 h-4"></i>
                    Export CSV
                </button>
                <div class="ml-auto text-sm text-gray-600">
                    Total Responses: <span id="totalResponses" class="font-semibold">—</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Top Metrics -->
    <section class="container mx-auto px-4 mb-8" data-aos="fade-up">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(59,130,246,.1); color:#3b82f6;">
                    <i data-feather="users"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Total Responses</div>
                    <div class="metric-value" id="metricTotal">—</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(16,185,129,.1); color:#10b981;">
                    <i data-feather="briefcase"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Employment Rate</div>
                    <div class="metric-value" id="metricEmployment">—</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(244,63,94,.1); color:#f43f5e;">
                    <i data-feather="trending-down"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Unemployment Rate</div>
                    <div class="metric-value" id="metricUnemployment">—</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="background: rgba(234,179,8,.1); color:#eab308;">
                    <i data-feather="plane"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Considering Emigration</div>
                    <div class="metric-value" id="metricEmigration">—</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Charts Grid -->
    <main class="container mx-auto px-4 pb-16">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Demographics: Gender -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Gender Distribution</h3>
                    <span class="chart-subtitle">Q1: Jinsiga</span>
                </div>
                <div class="chart-body">
                    <canvas id="genderChart" height="240"></canvas>
                </div>
            </div>

            <!-- Demographics: Age -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Age Groups</h3>
                    <span class="chart-subtitle">Q2: Da'da</span>
                </div>
                <div class="chart-body">
                    <canvas id="ageChart" height="240"></canvas>
                </div>
            </div>

            <!-- Demographics: Year in University -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Year of Study</h3>
                    <span class="chart-subtitle">Q3: Sanadka dhigashada jaamacadda</span>
                </div>
                <div class="chart-body">
                    <canvas id="yearChart" height="240"></canvas>
                </div>
            </div>

            <!-- Demographics: Faculty -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Faculty Distribution</h3>
                    <span class="chart-subtitle">Q4: Faculty-ga dhigashada</span>
                </div>
                <div class="chart-body">
                    <canvas id="facultyChart" height="240"></canvas>
                </div>
            </div>

            <!-- Employment Status -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Employment Status</h3>
                    <span class="chart-subtitle">Q5: Ma shaqo ayaad haysaa hadda?</span>
                </div>
                <div class="chart-body">
                    <canvas id="employmentChart" height="240"></canvas>
                </div>
            </div>

            <!-- Job Search Duration -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Job Search Duration</h3>
                    <span class="chart-subtitle">Q6: Muddada raadinta shaqo</span>
                </div>
                <div class="chart-body">
                    <canvas id="jobSearchChart" height="240"></canvas>
                </div>
            </div>

            <!-- Unemployment Reasons (Radar) -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Unemployment Reasons (Radar)</h3>
                    <span class="chart-subtitle">Q7: Sababta ugu weyn ee shaqo la'aanta</span>
                </div>
                <div class="chart-body">
                    <canvas id="unemploymentRadarChart" height="280"></canvas>
                </div>
            </div>

            <!-- Confidence in Finding a Job -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Confidence in Finding a Job</h3>
                    <span class="chart-subtitle">Q8: Kalsoonida helitaanka shaqo</span>
                </div>
                <div class="chart-body">
                    <canvas id="confidenceChart" height="240"></canvas>
                </div>
            </div>

            <!-- Business Idea Due to Unemployment -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Considering Business due to Unemployment</h3>
                    <span class="chart-subtitle">Q9: Ka fikrinta ganacsi bilowdo</span>
                </div>
                <div class="chart-body">
                    <canvas id="businessIdeaChart" height="240"></canvas>
                </div>
            </div>

            <!-- Emigration Consideration -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Emigration Consideration</h3>
                    <span class="chart-subtitle">Q10: Ka fikrinta inaad dalka ka baxdo</span>
                </div>
                <div class="chart-body">
                    <canvas id="emigrationChart" height="240"></canvas>
                </div>
            </div>

            <!-- Emigration Reasons -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Top Emigration Reasons</h3>
                    <span class="chart-subtitle">Q11: Sababta ugu weyn ee tahriibka</span>
                </div>
                <div class="chart-body">
                    <canvas id="emigrationReasonsChart" height="240"></canvas>
                </div>
            </div>

            <!-- Destination Countries -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Preferred Destinations</h3>
                    <span class="chart-subtitle">Q12: Meelaha aad jeclaan lahayd inaad tagto</span>
                </div>
                <div class="chart-body">
                    <canvas id="destinationChart" height="240"></canvas>
                </div>
            </div>

            <!-- Will You Return Home? -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Would You Return Home?</h3>
                    <span class="chart-subtitle">Q13: Ku soo laaban dalkaaga mustaqbalka?</span>
                </div>
                <div class="chart-body">
                    <canvas id="returnHomeChart" height="240"></canvas>
                </div>
            </div>

            <!-- Emigration Impact -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Perceived Impact of Emigration</h3>
                    <span class="chart-subtitle">Q14: Saameynta tahriibka dalka</span>
                </div>
                <div class="chart-body">
                    <canvas id="emigrationImpactChart" height="240"></canvas>
                </div>
            </div>

            <!-- University Support -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">University Support Adequacy</h3>
                    <span class="chart-subtitle">Q15: Jaamacadda taageero ku filan</span>
                </div>
                <div class="chart-body">
                    <canvas id="universitySupportChart" height="240"></canvas>
                </div>
            </div>

            <!-- University Actions -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Recommended University Actions</h3>
                    <span class="chart-subtitle">Q16: Talloo ay jaamacaduhu qaadan karaan</span>
                </div>
                <div class="chart-body">
                    <canvas id="universityActionsChart" height="240"></canvas>
                </div>
            </div>

            <!-- Government Policy Need -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Need for Government Policies</h3>
                    <span class="chart-subtitle">Q17: Baahida siyaasadda dowladda</span>
                </div>
                <div class="chart-body">
                    <canvas id="governmentPolicyChart" height="240"></canvas>
                </div>
            </div>

            <!-- SYLEAD Program Participation -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">SYLEAD Program Participation</h3>
                    <span class="chart-subtitle">Q18: Ka qayb gelinta barnaamijyada SYLEAD</span>
                </div>
                <div class="chart-body">
                    <canvas id="syleadProgramChart" height="240"></canvas>
                </div>
            </div>

            <!-- Future Outlook -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Future Career Outlook</h3>
                    <span class="chart-subtitle">Q19: Mustaqbalka shaqada</span>
                </div>
                <div class="chart-body">
                    <canvas id="futureOutlookChart" height="240"></canvas>
                </div>
            </div>

            <!-- Desire to Emigrate -->
            <div class="chart-card" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Desire to Emigrate</h3>
                    <span class="chart-subtitle">Q20: Rabitaanka tahriibto</span>
                </div>
                <div class="chart-body">
                    <canvas id="wantToEmigrateChart" height="240"></canvas>
                </div>
            </div>

            <!-- Comments Word Cloud (Bar) -->
            <div class="chart-card lg:col-span-2" data-aos="zoom-in">
                <div class="chart-header">
                    <h3 class="chart-title">Comments Word Frequency</h3>
                    <span class="chart-subtitle">Q21: Taloyin iyo faallooyin (optional)</span>
                </div>
                <div class="chart-body">
                    <canvas id="commentsWordCloud" height="300"></canvas>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="py-8 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            Built with TailwindCSS, Chart.js, and Firebase Firestore. Glassmorphism UI with animated bubbles.
        </div>
    </footer>

    <script>
        /* SYLEAD Survey Analysis Dashboard Script */

const firebaseConfig = {
    apiKey: "AIzaSyBUc5hcM-aDwF3YqLkMrlGQ39aUKesAPwI",
    authDomain: "sylead-surveys.firebaseapp.com",
    projectId: "sylead-surveys",
    storageBucket: "sylead-surveys.firebasestorage.app",
    messagingSenderId: "1022858819367",
    appId: "1:1022858819367:web:819cc345a439ccb691db02",
    measurementId: "G-E9E04BWX5Y"
};

// Color palette for charts
const palette = [
    "#4F46E5", // indigo-600
    "#06B6D4", // cyan-500
    "#10B981", // emerald-500
    "#F59E0B", // amber-500
    "#EF4444", // red-500
    "#8B5CF6", // violet-500
    "#F43F5E", // rose-500
    "#22C55E", // green-500
    "#3B82F6", // blue-500
    "#EAB308", // yellow-500
    "#F97316", // orange-500
    "#6366F1", // indigo-500
    "#84CC16", // lime-500
    "#A855F7", // purple-500
    "#EC4899", // pink-500
    "#14B8A6"  // teal-500
];

let charts = {};
let lastDataSnapshot = [];

/* Initialize Firebase */
let app, db;
try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
} catch (e) {
    console.warn("Firebase init failed; falling back to sample data.", e);
}

function qs(sel) { return document.querySelector(sel); }
function qsa(sel) { return Array.from(document.querySelectorAll(sel)); }

function setBadge(source) {
    const badge = qs("#dataSourceBadge");
    const txt = qs("#dataSourceText");
    if (source === "firebase") {
        badge.className = "inline-flex items-center gap-2 rounded-full px-4 py-2 bg-green-50 text-green-700 border border-green-200";
        txt.textContent = "Live Data (Firestore)";
    } else {
        badge.className = "inline-flex items-center gap-2 rounded-full px-4 py-2 bg-amber-50 text-amber-700 border border-amber-200";
        txt.textContent = "Sample Data (Mock)";
    }
}

/* Data fetching: Firestore -> documents */
async function fetchSurveyData() {
    if (!db) {
        return { source: "sample", data: sampleData() };
    }
    try {
        const snapshot = await db.collection("unemployment survey").get();
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (!data.length) {
            console.info("Firestore collection is empty. Using sample data.");
            return { source: "sample", data: sampleData() };
        }
        return { source: "firebase", data };
    } catch (err) {
        console.warn("Firestore read failed; using sample data.", err);
        return { source: "sample", data: sampleData() };
    }
}

/* Sample mock dataset for demo purposes */
function sampleData() {
    // 120 mock responses
    const genders = ["Lab", "Dhedig"];
    const ages = ["18-21", "22-25", "26-30"];
    const years = ["1st", "2nd", "3rd", "4th+"];
    const faculties = ["Social science and law", "Business and commerce", "Engineering and technology", "Health and medicine", "Education/sharia"];
    const employment = ["Full time", "Part time", "No"];
    const jobDurations = ["<3 months", "3-6 months", "6-12 months", ">1 year", "Not searching"];
    const unempReasons = ["Few job opportunities", "Lack of skills", "Nepotism", "Low education quality", "Lack of experience"];
    const confidence = ["Very confident", "Somewhat confident", "Not confident", "Not sure"];
    const businessIdea = ["Yes", "No", "Maybe"];
    const emigration = ["Yes", "No"];
    const emigrationReasons = ["Better job opportunities", "Higher education", "Better life and services", "Security and stability", "Family abroad"];
    const destinations = ["Europe", "America", "Middle East", "Africa", "Asia"];
    const returnHome = ["Yes, fully", "Maybe", "No", "Not sure"];
    const emigrationImpact = ["Positive", "Negative", "Both", "Not sure"];
    const universitySupport = ["Yes", "No", "Yes but can improve"];
    const universityActions = ["Training and internship programs", "Business and entrepreneurship training", "Job search counseling", "Job fairs and networking"];
    const governmentPolicy = ["Yes", "No"];
    const syleadProgram = ["Yes", "No", "Maybe"];
    const futureOutlook = ["Optimistic", "Neutral", "Pessimistic", "Not sure"];
    const wantToEmigrate = ["Yes 100%", "Would like but can't", "No, I like my country"];

    const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const arr = [];
    for (let i = 0; i < 120; i++) {
        arr.push({
            gender: rand(genders),
            age: rand(ages),
            year: rand(years),
            faculty: rand(faculties),
            employment: rand(employment),
            jobSearchDuration: rand(jobDurations),
            unemploymentReason: rand(unempReasons),
            confidence: rand(confidence),
            businessIdea: rand(businessIdea),
            emigration: rand(emigration),
            emigrationReason: rand(emigrationReasons),
            destination: rand(destinations),
            returnHome: rand(returnHome),
            emigrationImpact: rand(emigrationImpact),
            universitySupport: rand(universitySupport),
            universityAction: rand(universityActions),
            governmentPolicy: rand(governmentPolicy),
            syleadProgram: rand(syleadProgram),
            futureOutlook: rand(futureOutlook),
            wantToEmigrate: rand(wantToEmigrate),
            comments: Math.random() > 0.7 ? "I think the government should create more job programs for graduates and encourage entrepreneurship." : ""
        });
    }
    return arr;
}

/* Utilities */
function countBy(arr, key) {
    const map = new Map();
    arr.forEach(item => {
        const val = item?.[key];
        if (!val) return;
        const k = String(val).trim();
        map.set(k, (map.get(k) || 0) + 1);
    });
    // Sort by value desc
    return Array.from(map.entries()).sort((a, b) => b[1] - a[1]);
}
function pct(part, total) {
    return total ? ((part / total) * 100).toFixed(1) + "%" : "0%";
}
function flattenComments(arr) {
    return arr.map(a => a?.comments).filter(Boolean);
}
function stopWords() {
    return new Set([
        "i","me","my","myself","we","our","ours","ourselves","you","your","yours","yourself","yourselves","he","him","his","himself","she","her","hers","herself","it","its","itself","they","them","their","theirs","themselves",
        "what","which","who","whom","this","that","these","those","am","is","are","was","were","be","been","being","have","has","had","having","do","does","did","doing","a","an","the","and","but","if","or","because","as","until","while","of",
        "at","by","for","with","about","against","between","into","through","during","before","after","above","below","to","from","up","down","in","out","on","off","over","under","again","further","then","once","here","there","when","where",
        "why","how","all","any","both","each","few","more","most","other","some","such","no","nor","not","only","own","same","so","than","too","very","can","will","just","don","should","now","ma","ay","waxaan","lakin","in","ka","ee","si",
        "lahaad","lahayd","u","la","aad","mid","nooc","laakiin","istaa","ayaa","ayay","qoraal","qor","faallo","talo","dalka","dalki","dhalinyarada","shqlo","shaqo","jaamacadda","shirkad","shirkada","isku","ay","yaqaan","waxa","waxay","sida",
        "dhigashada","dhigato","sano","sanadka","hadda","mustaqbalka","ma","maya","haa","wixii","kii","kaa","kuu","noqo","nuqul","kale","qaar","qaartee","sidee","side","sideena","daraasad","daraasadda","aynu","ayn","ayaan"
    ]);
}
function wordFrequency(textArray) {
    const words = [];
    textArray.forEach(t => {
        String(t).toLowerCase().replace(/[^a-z0-9\s']/g, " ").split(/\s+/).forEach(w => {
            if (!w || w.length < 3) return;
            words.push(w);
        });
    });
    const map = new Map();
    const banned = stopWords();
    words.forEach(w => {
        if (banned.has(w)) return;
        map.set(w, (map.get(w) || 0) + 1);
    });
    return Array.from(map.entries()).sort((a,b) => b[1]-a[1]).slice(0, 25);
}

/* Chart helpers */
function destroyChart(id) {
    if (charts[id]) {
        charts[id].destroy();
        delete charts[id];
    }
}
function makeChart(id, config) {
    destroyChart(id);
    const ctx = document.getElementById(id);
    if (!ctx) return;
    charts[id] = new Chart(ctx, config);
}
function pieConfig(id, labels, values, title) {
    return {
        type: 'pie',
        data: {
            labels,
            datasets: [{
                data: values,
                backgroundColor: labels.map((_, i) => palette[i % palette.length]),
                borderWidth: 2,
                borderColor: "#fff"
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } },
                title: { display: false, text: title }
            }
        }
    };
}
function doughnutConfig(id, labels, values, title) {
    return {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data: values,
                backgroundColor: labels.map((_, i) => palette[i % palette.length]),
                borderWidth: 2,
                borderColor: "#fff"
            }]
        },
        options: {
            responsive: true,
            cutout: "55%",
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } },
                title: { display: false, text: title }
            }
        }
    };
}
function barConfig(id, labels, values, title, horizontal = false) {
    return {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Count',
                data: values,
                backgroundColor: labels.map((_, i) => palette[i % palette.length]),
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: horizontal ? 'y' : 'x',
            responsive: true,
            scales: {
                x: { grid: { display: false }, ticks: { color: "#475569" } },
                y: { grid: { color: "rgba(15,23,42,0.06)" }, ticks: { color: "#475569" } }
            },
            plugins: {
                legend: { display: false },
                title: { display: false, text: title }
            }
        }
    };
}
function lineConfig(id, labels, values, title) {
    return {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Count',
                data: values,
                borderColor: palette[0],
                backgroundColor: "rgba(79,70,229,0.15)",
                tension: 0.35,
                fill: true,
                pointBackgroundColor: palette[0],
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { grid: { display: false }, ticks: { color: "#475569" } },
                y: { grid: { color: "rgba(15,23,42,0.06)" }, ticks: { color: "#475569" } }
            },
            plugins: { legend: { display: false }, title: { display: false, text: title } }
        }
    };
}
function radarConfig(id, labels, values, title) {
    return {
        type: 'radar',
        data: {
            labels,
            datasets: [{
                label: 'Responses',
                data: values,
                backgroundColor: "rgba(79,70,229,0.20)",
                borderColor: palette[0],
                pointBackgroundColor: palette[0],
                pointBorderColor: "#fff",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: palette[0]
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    angleLines: { color: "rgba(15,23,42,0.1)" },
                    grid: { color: "rgba(15,23,42,0.1)" },
                    pointLabels: { color: "#334155" },
                    ticks: { display: false }
                }
            },
            plugins: { legend: { display: false }, title: { display: false, text: title } }
        }
    };
}

/* Rendering */
function renderAll(data) {
    const total = data.length;
    lastDataSnapshot = data;

    qs("#totalResponses").textContent = total;
    qs("#metricTotal").textContent = total;

    // Metrics
    const employed = countBy(data, "employment");
    const empFull = +(employed.find(x => x[0] === "Full time")?.[1] || 0);
    const empPart = +(employed.find(x => x[0] === "Part time")?.[1] || 0);
    const empTotal = empFull + empPart;
    const unemployed = +(employed.find(x => x[0] === "No")?.[1] || 0);

    qs("#metricEmployment").textContent = pct(empTotal, total);
    qs("#metricUnemployment").textContent = pct(unemployed, total);

    const emigrationYes = +(countBy(data, "emigration").find(x => x[0] === "Yes")?.[1] || 0);
    qs("#metricEmigration").textContent = pct(emigrationYes, total);

    // Charts
    // 1. Gender
    const gender = countBy(data, "gender");
    makeChart("genderChart", pieConfig("genderChart", gender.map(x => x[0]), gender.map(x => x[1])));

    // 2. Age
    const age = countBy(data, "age");
    makeChart("ageChart", barConfig("ageChart", age.map(x => x[0]), age.map(x => x[1])));

    // 3. Year
    const year = countBy(data, "year");
    makeChart("yearChart", barConfig("yearChart", year.map(x => x[0]), year.map(x => x[1])));

    // 4. Faculty
    const faculty = countBy(data, "faculty");
    makeChart("facultyChart", doughnutConfig("facultyChart", faculty.map(x => x[0]), faculty.map(x => x[1])));

    // 5. Employment
    const employment = countBy(data, "employment");
    makeChart("employmentChart", doughnutConfig("employmentChart", employment.map(x => x[0]), employment.map(x => x[1])));

    // 6. Job search duration
    const jobSearch = countBy(data, "jobSearchDuration");
    makeChart("jobSearchChart", lineConfig("jobSearchChart", jobSearch.map(x => x[0]), jobSearch.map(x => x[1])));

    // 7. Unemployment reasons radar
    const unempReason = countBy(data, "unemploymentReason");
    makeChart("unemploymentRadarChart", radarConfig("unemploymentRadarChart", unempReason.map(x => x[0]), unempReason.map(x => x[1])));

    // 8. Confidence
    const confidence = countBy(data, "confidence");
    makeChart("confidenceChart", barConfig("confidenceChart", confidence.map(x => x[0]), confidence.map(x => x[1])));

    // 9. Business Idea
    const businessIdea = countBy(data, "businessIdea");
    makeChart("businessIdeaChart", barConfig("businessIdeaChart", businessIdea.map(x => x[0]), businessIdea.map(x => x[1])));

    // 10. Emigration
    const emigration = countBy(data, "emigration");
    makeChart("emigrationChart", pieConfig("emigrationChart", emigration.map(x => x[0]), emigration.map(x => x[1])));

    // 11. Emigration reasons
    const emigrationReasons = countBy(data, "emigrationReason");
    makeChart("emigrationReasonsChart", barConfig("emigrationReasonsChart", emigrationReasons.map(x => x[0]), emigrationReasons.map(x => x[1])));

    // 12. Destinations
    const destinations = countBy(data, "destination");
    makeChart("destinationChart", barConfig("destinationChart", destinations.map(x => x[0]), destinations.map(x => x[1])));

    // 13. Return home
    const returnHome = countBy(data, "returnHome");
    makeChart("returnHomeChart", barConfig("returnHomeChart", returnHome.map(x => x[0]), returnHome.map(x => x[1])));

    // 14. Emigration impact
    const emigrationImpact = countBy(data, "emigrationImpact");
    makeChart("emigrationImpactChart", doughnutConfig("emigrationImpactChart", emigrationImpact.map(x => x[0]), emigrationImpact.map(x => x[1])));

    // 15. University support
    const universitySupport = countBy(data, "universitySupport");
    makeChart("universitySupportChart", barConfig("universitySupportChart", universitySupport.map(x => x[0]), universitySupport.map(x => x[1])));

    // 16. University actions
    const universityActions = countBy(data, "universityAction");
    makeChart("universityActionsChart", barConfig("universityActionsChart", universityActions.map(x => x[0]), universityActions.map(x => x[1])));

    // 17. Government policy
    const governmentPolicy = countBy(data, "governmentPolicy");
    makeChart("governmentPolicyChart", pieConfig("governmentPolicyChart", governmentPolicy.map(x => x[0]), governmentPolicy.map(x => x[1])));

    // 18. SYLEAD program
    const syleadProgram = countBy(data, "syleadProgram");
    makeChart("syleadProgramChart", barConfig("syleadProgramChart", syleadProgram.map(x => x[0]), syleadProgram.map(x => x[1])));

    // 19. Future outlook
    const futureOutlook = countBy(data, "futureOutlook");
    makeChart("futureOutlookChart", barConfig("futureOutlookChart", futureOutlook.map(x => x[0]), futureOutlook.map(x => x[1])));

    // 20. Want to emigrate
    const wantToEmigrate = countBy(data, "wantToEmigrate");
    makeChart("wantToEmigrateChart", barConfig("wantToEmigrateChart", wantToEmigrate.map(x => x[0]), wantToEmigrate.map(x => x[1])));

    // 21. Comments word frequency
    const words = wordFrequency(flattenComments(data));
    makeChart("commentsWordCloud", barConfig("commentsWordCloud", words.map(x => x[0]), words.map(x => x[1])));

    // Timestamp
    qs("#lastUpdated").textContent = "Last updated: " + new Date().toLocaleString();
}

/* Export functions */
function exportChartsAsPNG() {
    Object.entries(charts).forEach(([id, chart]) => {
        const url = chart.toBase64Image("image/png", 1);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${id}.png`;
        a.click();
    });
}
function exportCSV() {
    const headers = [
        "gender","age","year","faculty","employment","jobSearchDuration","unemploymentReason","confidence",
        "businessIdea","emigration","emigrationReason","destination","returnHome","emigrationImpact",
        "universitySupport","universityAction","governmentPolicy","syleadProgram","futureOutlook","wantToEmigrate","comments"
    ];
    const rows = lastDataSnapshot.map(obj => headers.map(h => {
        const v = obj?.[h] ?? "";
        // Escape CSV
        const s = String(v).replace(/"/g, '""');
        return `"${s}"`;
    }));
    const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "sylead_survey_export.csv";
    a.click();
    URL.revokeObjectURL(url);
}

/* Event bindings */
qs("#refreshBtn").addEventListener("click", async () => {
    const { source, data } = await fetchSurveyData();
    setBadge(source);
    renderAll(data);
});
qs("#exportPngBtn").addEventListener("click", exportChartsAsPNG);
qs("#exportCsvBtn").addEventListener("click", exportCSV);

/* Initial load */
(async function init() {
    const { source, data } = await fetchSurveyData();
    setBadge(source);
    renderAll(data);
})();
    </script>
    <script>
        // Replace icons
        feather.replace();

        // Initialize AOS
        AOS.init({ duration: 700, once: true });
    </script>
<script src="https://huggingface.co/deepsite/deepsite-badge.js"></script>
</body>
</html>
